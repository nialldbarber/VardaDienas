workflows:
  ios-testflight:
    name: iOS TestFlight Build
    max_build_duration: 60
    environment:
      vars:
        XCODE_WORKSPACE: "VardaDienas.xcworkspace"
        XCODE_SCHEME: "VardaDienas"
        BUNDLE_ID_MAIN: "com.nialldbarber.vardadienas"
        BUNDLE_ID_WIDGET: "com.nialldbarber.vardadienas.VardaDienasWidget"
        APP_STORE_CONNECT_TEAM_ID: "95P8RUD7QB"
      groups:
        - ios-credentials
      xcode: latest
      cocoapods: default
      ios_signing:
        distribution_type: app_store
        bundle_identifier:
          - name: com.nialldbarber.vardadienas
            provisioning_profile: varda-dist-pp
          - name: com.nialldbarber.vardadienas.VardaDienasWidget
            provisioning_profile: varda-dist-widget
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
          source: true
    scripts:
      - name: Install dependencies
        script: |
          npm install
          npx pod-install
      - name: Build IPA
        script: |
          xcodebuild -workspace "$XCODE_WORKSPACE" \
                     -scheme "$XCODE_SCHEME" \
                     -configuration Release \
                     -sdk iphoneos \
                     -archivePath $CM_BUILD_DIR/Build/Archive.xcarchive \
                     clean archive \
                     DEVELOPMENT_TEAM=$APP_STORE_CONNECT_TEAM_ID \
                     PRODUCT_BUNDLE_IDENTIFIER=$BUNDLE_ID_MAIN

          xcodebuild -exportArchive \
                     -archivePath $CM_BUILD_DIR/Build/Archive.xcarchive \
                     -exportOptionsPlist ios/exportOptions.plist \
                     -exportPath $CM_BUILD_DIR/Build/IPA
    artifacts:
      - Build/IPA/*.ipa
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/Products/**/*.dSYM
    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
